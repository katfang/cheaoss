syntax = "proto3";

package cheaoss.v1;

import "rbt/v1alpha1/options.proto";

message Cheaoss {
    option (rbt.v1alpha1.state) = {};
    Team next_team_assignment = 1;
    Team next_team_to_move = 2;
    repeated string piece_ids = 3;
    map<string, Team> players = 4;
    repeated MoveRequest white_moves_queue = 5;
    repeated MoveRequest black_moves_queue = 6;
    map<string, bool> outstanding_player_moves = 7;
    map<string, bool> outstanding_piece_moves = 8;
}

enum Team {
    TEAM_UNKNOWN = 0;
    WHITE = 1;
    BLACK = 2;
} 

message Location {
    uint32 row = 1;
    uint32 col = 2;
}

enum PieceType {
    PIECES_TYPE_UNKNOWN = 0;
    PAWN = 1;
    BISHOP = 2;
    KNIGHT = 3;
    ROOK = 4;
    QUEEN = 5;
    KING = 6;
}

message Piece {
    option (rbt.v1alpha1.state) = {};
    Team team = 1;
    PieceType type = 2;
    Location loc = 3;
}

// Maps gameid-row-col --> pieceid
message LocPieceIndex {
    option (rbt.v1alpha1.state) = {};
    string piece_id = 1;
}

service CheaossMethods {
    rpc AssignTeam(AssignTeamRequest) returns (AssignTeamResponse) {
        option (rbt.v1alpha1.method).writer = {};
    }

    rpc InitGame(InitGameRequest) returns (EmptyResponse) {
        option (rbt.v1alpha1.method).transaction = {};
    }

    rpc BoardPieces(EmptyRequest) returns (BoardPiecesResponse) {
        option (rbt.v1alpha1.method).reader = {};
    }

    rpc QueueMove(MoveRequest) returns (EmptyResponse) {
        option (rbt.v1alpha1.method) = {
            writer: {},
            errors: [ "InvalidMoveError" ],
        };
    }

    rpc RunQueue(EmptyRequest) returns (EmptyResponse) {
        option (rbt.v1alpha1.method).transaction = {};
    }

    rpc Queues(EmptyRequest) returns (QueuesResponse) {
        option (rbt.v1alpha1.method).reader = {};
    }

    rpc HasOutstandingMove(HasOutstandingMoveRequest) returns (HasOutstandingMoveResponse) {
        option (rbt.v1alpha1.method).reader = {};
    }
}

message EmptyRequest {}
message EmptyResponse {}

message AssignTeamRequest {
    string player_id = 1;
}

message AssignTeamResponse {
    Team team = 1; 
}

message InitGameRequest {}

message BoardPiecesResponse {
    map<string, cheaoss.v1.Piece> pieces = 1;
}

message MoveRequest {
    string player_id = 1;
    string piece_id = 2;
    Location start = 3;
    Location end = 4;
}

message QueuesResponse {
    repeated MoveRequest white_moves_queue = 1;
    repeated MoveRequest black_moves_queue = 2;
}

message HasOutstandingMoveRequest {
    string player_id = 1;
}

message HasOutstandingMoveResponse {
    bool hasMove = 1;
}

message InvalidMoveError {
    string message = 1;
}

message LocationRequiredError {}

service PieceMethods {
    rpc MakePiece(cheaoss.v1.Piece) returns (EmptyResponse) {
        option (rbt.v1alpha1.method) = {
            transaction: {},
            errors: [ "LocationRequiredError" ],
        };
    }

    rpc Piece(EmptyRequest) returns (cheaoss.v1.Piece) {
        option (rbt.v1alpha1.method).reader = {};
    }

    rpc MovePiece(MoveRequest) returns (EmptyResponse) {
        option (rbt.v1alpha1.method) = {
            transaction: {},
            errors: [ "InvalidMoveError" ],
        };
    }
}

service LocPieceIndexMethods {
    rpc Get(EmptyRequest) returns (cheaoss.v1.LocPieceIndex) {
        option (rbt.v1alpha1.method).reader = {};
    }

    rpc Set(cheaoss.v1.LocPieceIndex) returns (EmptyResponse) {
        option (rbt.v1alpha1.method).writer = {};
    }

    rpc Delete(EmptyRequest) returns (EmptyResponse) {
        option (rbt.v1alpha1.method).writer = {};
    }
}